<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Teste NFC (UID / NDEF)</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; }
    pre { background:#f5f5f5; padding:10px; border-radius:6px; }
    button { padding:10px 16px; font-size:16px; }
  </style>
</head>
<body>
  <h2>Teste NFC (UID / NDEF)</h2>
  <p>Clique em <b>Iniciar</b> e aproxime o cartão MIFARE Classic.</p>
  <button id="start">Iniciar</button>
  <pre id="out">Pronto.</pre>

  <script>
    const out = document.getElementById('out');
    const start = document.getElementById('start');

    function log(...t) { out.textContent += '\\n' + t.join(' '); out.scrollTop = out.scrollHeight; }

    start.addEventListener('click', async () => {
      out.textContent = 'Pedindo permissão para NFC...';
      if (!('NDEFReader' in window)) {
        out.textContent = 'Web NFC não suportado neste navegador/dispositivo.';
        return;
      }

      try {
        const ndef = new NDEFReader();
        await ndef.scan(); // requer ação do usuário
        out.textContent = 'Aproxime a tag... (aguardando leitura)';

        ndef.onreadingerror = () => log('Erro ao ler a tag.');
        ndef.onreading = (event) => {
          log('--- Leitura ---');
          try {
            const sn = event.serialNumber || '';
            log('serialNumber (UID):', sn || '(não disponível)');
            // mensagem NDEF (se houver)
            const msg = event.message;
            if (msg && msg.records && msg.records.length) {
              log('Registros NDEF encontrados:', msg.records.length);
              for (const r of msg.records) {
                log('recordType:', r.recordType, '| mediaType:', r.mediaType || '-', '| id:', r.id || '-');
                // tentar interpretar texto/url
                if (r.recordType === 'text') {
                  const textDecoder = new TextDecoder(r.encoding || 'utf-8');
                  log('→ texto:', textDecoder.decode(r.data));
                } else if (r.recordType === 'url') {
                  const url = new TextDecoder().decode(r.data);
                  log('→ url:', url);
                } else {
                  log('→ dados (hex):', Array.from(new Uint8Array(r.data || [])).map(b=>b.toString(16).padStart(2,'0')).join(''));
                }
              }
            } else {
              log('Nenhum registro NDEF presente (ou tag não NDEF).');
            }
          } catch (e) {
            log('Erro ao processar leitura:', e.message || e);
          }
        };
      } catch (err) {
        out.textContent = 'Falha ao iniciar scanner: ' + err;
      }
    });
  </script>
</body>
</html>
